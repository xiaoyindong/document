## 1. 概述

大前端这几年算是一个热词，对于前段来说如果不是大前端，技术相对来说就已经算是落后了。如果还停留在对```ES6```，```Vue```这些基本技能的学习只能说处于一个及格线。

如果想做的卓越必须必备另一些大前端技能，比如说```NodeJS```，```express.js```,```koaJs```服务类，或者```three.js```这类```3d```数据图像，还有二维图像处理，比如```d3```,```raphael```,```echart```, 最后```hls```,```flv```视频行业。

如果只会```ES6```,```Vue```，```React```,```Webpack```这只能算是前端，大前端是至少要掌握上面的一项技能的。这篇文章就是介绍大前端领域中的视频直播。

本文主要讲述的是```H5```前端部分，视频音频采集部分后面会但开篇章来讲。首先带领大家快速实现一个直播系统，然后再讲解其中的重要概念，话不多说，直接开撸。

## 2. 工具安装

这里首先讲述mac系统的操作方法，```windows```系统安装方式在下面。需要的工具我已经传到的```github```上，可以自行下载。[git地址](https://github.com/xiaoyindong/h5live)

![](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3aba7625efb74007801babb996ffd937~tplv-k3u1fbpfcp-watermark.image)

```server```是推流工具，```tools```里面有下面需要安装的工具。

### 1. Mac安装ffmpeg

首先需要安装```YASM```，如果没有安装```yasm```的话，会报```FFmpeg yasm/nasm not found or too old. Use --disable-yasm for a crippledbuild```这个问题，如果没有安装```sdl```的话，安装完```FFmpeg```之后，```bin```目录下没有```ffplay```这个文件。

安装```yasm```[yasm](http://www.tortall.net/projects/yasm/releases/yasm-1.3.0.tar.gz);

```s
# 可以在h5live中找到yasm
cd /h5live/tools/yasm-1.3.0
# 配置
./configure
# 编译 & 安装
 make
 sudo make install
```

安装```sdl```[sdl](http://libsdl.org/release/SDL2-2.0.8.tar.gz);

```s
# 切可以在h5live中找到sdl目录
cd /h5live/tools/SDL2-2.0.8
# 配置
./configure
# 编译 & 安装
make -j 16
sudo make install
```

安装```ffmpeg```[ffmpeg](http://ffmpeg.org/download.html);

```s
# 切可以在h5live中找到ffmpeg，prefix为要安装到的位置
cd /h5live/tools/ffmpeg-4.3
# 配置
./configure --prefix=/usr/local/ffmpeg --enable-debug=3 --enable-shared --disable-static
# 编译 & 安装
make -j 4 
sudo make install
```

设置```ffmpeg```软连接, 相当于环境变量，目的是为了在任何目录都可以使用```ffmpeg```命令，```/usr/local/ffmpeg-4.3/ffmpeg```是安装的路径

```s
ln -s /usr/local/ffmpeg-4.3/ffmpeg /usr/local/bin/ffmpeg
```

### 2. Windows 系统

```FFmpeg```程序进行各种媒体格式的转换，使得它们可以在不同设备上播放。该程序只有命令行模式，因此将它安装到计算机中看上去有点麻烦，但是只要根据本指南的方法，你只需要几分钟就可以将```FFmpeg```安装成功！

下载```ffmpeg```:

![](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/549255e9ccd04f609bae535802a4aa86~tplv-k3u1fbpfcp-watermark.image)

访问下载页面时，你将看到很多不同下载选项。你可以根据自己的操作系统选择下载最新的32位或64位静态程序版本。

![](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/017810ba43bf4f3b8667472d153dc8d5~tplv-k3u1fbpfcp-watermark.image)

安装:

点击开始菜单，然后点击计算机。选择安装```Windows```系统的磁盘（一般是```C:```）。在```C:```盘的根目录下（该目录下有名为```Windows```和```Program Files```文件夹），右击并在弹出菜单中选择新建文件夹。将新文件夹命名为```ffmpeg```。将下载的```ffmpeg```压缩包解压到这个文件夹中。


在环境变量中加入```ffmpeg```的启动命令，```c:\ffmpeg\bin```, 俗称配置环境变量。

打开命令提示符窗口，输入命令```ffmpeg –version```。如果命令提示窗口返回```FFmpeg```的版本信息，那么就说明安装成功了，你可以在命令提示行中任意文件夹下运行```FFmpeg```。

如果你收到```libstdc++ -6 is missing```的错误消息，那么你可能需要安装```Microsoft Visual C++ Redistributable Package```，该软件包可以在微软网站免费获取。

## 3. 启动server

很简单，进入从```github```中获取到的```h5live```中```server```所在的目录，运行```server```程序即可。

```s
cd /h5live/server
open server
```

![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/423f48afa14a4f47a8f42182d8408319~tplv-k3u1fbpfcp-watermark.image)

可以看到这里提供了三种协议的路径，分别是```rtmp```协议的```1935```接口，```http-flv```协议的```7001```端口和```hls```的```7002```端口。

## 4. 执行推流

找一个```mp4```格式的视频文件，假设这个文件叫```1.mp4```，可以在```1.map```所在的文件夹下执行下面的命令。

```s
ffmpeg -re -i 1.mp4 -c copy -f flv rtmp://127.0.0.1:1935/live/movie
```

出现下图的效果就表示```1.MP4```这个视频开始进行流推送了。

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f7aec202e6084bf5b6bb98a3dece0ecd~tplv-k3u1fbpfcp-watermark.image)

## 5. 视频验证

上面已经说了```server```工具提供三种协议的视频流，分别是```rtmp```，```http-flv```以及```hls```。

可以使用```VLC```播放器验证```rtmp```协议的视频流。

![](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0f1f372ebf7344868aa265a462c2ac11~tplv-k3u1fbpfcp-watermark.image)

在里面粘贴入```rtmp://127.0.0.1:1935/live/movie```

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4cf22742a71e4ad0ab64f9e33583a989~tplv-k3u1fbpfcp-watermark.image)

然后就可以看到直播的效果了。

![](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f24fc53bb1ad46f88dfaa002e0ff5b72~tplv-k3u1fbpfcp-watermark.image)

下载```VLC```播放器:

1. Mac 系统

[Mac OS X](https://www.videolan.org/vlc/index.zh.html)

2. Windows 系统

[Windows](https://www.videolan.org/vlc/index.zh.html)

```hls```协议的流媒体可以使用```Safari```浏览器直接打开观看。可以直接把```http://127.0.0.1:7002/live/movie.m3u8```放到```Safari```浏览器的地址栏中查看效果。

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7245215d72f448c18a8fac05069f1b2d~tplv-k3u1fbpfcp-watermark.image)

至此推流就做完了，在```H5```的直播开发中，这些工作都是服务器，之所以演示这些是为了在实际的开发中可以懂得直播的过程，可以快速的给出直播的解决方案。最主要的在服务还没有开发完成之前可以通过这样的方式快速搭建一个推流系统，前端先开发起来。

```s
# RTMP，可以使用VLC播放器
rtmp://127.0.0.1:1935/live/movie
# FLV
http://127.0.0.1:7001/live/movie.flv
# HLS 可以使用Safari浏览器访问
http://127.0.0.1:7002/live/movie.m3u8
```

## 6. H5端播放器

这里才是前端真正需要关心的部分，主要介绍如何用```js```去写一个直播的播放器，选择一些已有的最佳实践是最稳妥的，这样可以快速的满足业务需求，这里会介绍三款播放器，以及他们的使用。同样这些代码我也传到了```github```上。

[video.js](https://github.com/videojs/video.js)是国外比较流行的视频框架，他的特长是做了非常好的自定义ui，符合线上成品的场景，除了自定义```ui```，还提供了很多插件，比如弹幕，快捷键，```hls```支持等等。他是一个比较完整的```js```框架，点播、直播都很合适，缺点是文件较大。

[hls.js]()适合做```hls```协议的一款小巧的框架，同样也是点播直播都可以。缺点是需要自己书写UI样式。```video.js```可以支持hls也是因为插件是基于```hls.js```

[flv.js]()是```B```站开源的```flv```格式的播放器，如果是```http-flv```协议的直播用它是非常合适的。

至于```rtmp```在```H5```的直播中是不常用的，所以这里就不讲了。

## 7. 使用videojs开发

在```github```找到[videojs](https://github.com/videojs/video.js), 可以在这个网址中找到下面的两个文件，下载下来放在本地。

![](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/93f1df090d7448eea9ba4a9179652978~tplv-k3u1fbpfcp-watermark.image)

在```Video.js```的插件文档中存在大量的插件，可以从中找到自己需要的。```https://videojs.com/plugins/```

```videojs-contrib-hls```是一个支持```hls```直播的```video```插件。找到```cdn```, 将```js```保存到本地。使用方式很简单，只需要把插件的```js```引入进来就可以了。

![](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/db91270e3d1c4a6bbabbfd027bc269d0~tplv-k3u1fbpfcp-watermark.image)

将```video.min.js```和```videojs-contrib-hls.js```以及```video-js.min.css```引入到页面中，```source```标签的地址写上```hls```的```m3u8```后缀地址。就可以了。

注意这里需要在服务器环境查看。

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="vi