## 1. 概述
 
很多人可能或多或少了解过```nginx```，即使没有使用过```nginx```，但是可能用```Apache```搭建过简单的```web```服务器，用```tomcat```写过一些简单的动态页面，其实这些功能nginx都可以实现。

```nginx```最重要的三个使用场景个人认为是```静态资源服务```、```反向代理服务```和```api服务```。

```web```请求走进服务以后会先经过```nginx```再到应用服务，然后再去访问```redis```或者```mysql```提供基本的数据功能。

这就有个问题，应用服务因为要求开发效率高，所以他的运行效率是很低的，他的```qbs```，```tps```并发都是受限的，所以就需要把很多的应用服务组成集群，向用户提供高可用性。

很多服务构成集群的时候，需要```nginx```具有反向代理的功能，可以把动态请求传导给对应的应用服务。服务集群一定会带来两个需求，动态的扩容和容灾。

反向代理必须具备负载均衡的功能，其次在链路中，```nginx```是处在企业内网的边缘节点，随着网络链路的增长，用户体验到的时延会增加。

把一些所有用户看起来不变的，或者在一段时间内看起来不变的动态内容缓存在```nginx```部分，由```nginx```直接向用户提供访问，用户的时延就会减少很多。

反向代理衍生出另外的功能叫缓存，他能够加速访问，而很多时候在访问像```css```或```js```文件又或者一些小图片是没有必要由应用服务来访问的，他只需要直接由```nginx```提供访问就可以了这就是```nginx```的静态资源功能。

应用服务它本身的性能有很大的问题，数据库服务要比应用服务好的多，原因是数据库他的业务场景比较简单，并发性能和```tps```都要远高于应用服务。由```nginx```直接去访问数据库或者```redis```也是不错的选择。

还可以利用```nginx```强大的并发性能，实现如```web```防火墙的一些业务功能，这就要求```nginx```服务有非常强大的业务处理功能，```openResty```和```nginx```集成了一些工具库来实现此功能。

## 2. 历史背景

全球化和物联网的快速发展，导致接入互联网中的人与设备的数量都在快速的上升，数据的快速爆炸，对硬件性能提出很高的要求。

摩尔定律表明之前服务跑在```1GHZ```的```CPU```上的服务更新到```2GHZ```的```CPU```时服务会有两倍的性能提升。

但是到了本世纪初，摩尔定律在单颗```CPU```的频率上已经失效了，```CPU```开始向着多核方向发展，当服务器现在是跑在```8```核```CPU```上时，一年半以后换到了```16```核的```CPU```，服务的性能通常是不会有一倍的提升的。

这些性能主要损耗在操作系统和大量的软件没有做好服务于多核架构的准备，比如说像```Apache```是低效的，因为他的架构模型里一个进程同一时间，只会处理一个连接，一个请求。只有在这个请求处理完以后才会去处理下一个请求。

它实际上在使用操作系统的进程间切换的特性，因为操作系统微观上是有限的```CPU```，但是操作系统被设计为同时服务于数百甚至上千的进程。

```Apache```一个进程只能服务于一个连接，这种模式会导致当```Apache```需要面对几十万，几百万连接的时候，他没有办法去开几百万的进程，而进程间切换的代价成本又太高啦。

当并发的连接数越多，这种无谓的进程间切换引发的性能消耗又会越大。

```nginx```是专门为了这种应用场景而生的，可以处理数百万甚至上千万的并发连接，```nginx```目前在```web```市场份额中排行第二，在过去几年他增长极度迅速，在不久的将来```nginx```在```web```端的应用将远远超过其他服务器。

## 3. nginx的优点

大部分的程序和服务器随着并发连接数的上升他的```RPS```数会急剧的下降，这里的原理就像之前所说过的，他的设计架构是有问题的。

```nginx```的第一个优点就是高并发和高性能同时具备的，往往高并发只需要对每一个连接所使用的内存尽量的少就可以达到。

而具有高并发的同时达到高性能，往往需要非常好的设计，那```nginx```可以达到什么样的标准呢？

比如说现在主流的一些服务器```32```核```64G```的内存可以轻松达到数千万的并发链接，如果是处理一些简单的静态资源请求，可以达到一百万的```RPS```这种级别。

其次```nginx```的可扩展性非常好，主要在于他的模块化设计非常的稳定，而且```nginx```的第三方模块的生态圈非常的丰富。甚至于有像```TNG```,```openRestry```这种第三方插件。丰富的生态圈为```nginx```丰富的功能提供了保证。

第三个优点是它的高可靠性，所谓的高可靠性是指```nginx```可以在服务器上持续不间断的运行数年，而很多```web```服务器往往运行几周或者几个月就需要做一次重启。

对于```nginx```这种高并发高性能的反向代理服务器而言，他往往运行在企业内网的边缘节点上，如果企业想提供```4个9```，```5个9```，甚至更高的高可用性时，对于```nginx```持续运行能够```down```机的时间一年可能只能以秒来计。所以在这种角色中，```nginx```的高可靠性给提供了非常好的保证。

第四个优点热部署，是指可以在不停止服务的情况下升级```nginx```，这对于```nginx```来说非常的重要，因为在```nginx```可能跑了数百万的并发连接。

如果是普通的服务可能只需```kill```掉进程再重启的方式就可以处理好，但是对于```nginx```而言，因为```kill```掉```nginx```进程，会导致操作系统为所有的已经建立连接的客户端发送一个```tcp```中的```reset```报文。而很多客户端是没有办法很好的处理请求的。

在大并发场景下，一些偶然事件就会导致必然的恶性结果，所以热部署是非常有必要的。

第五个优点是```BSD```许可证，```BSD Listens```是指```nginx```不仅是开源的免费的，而且可以在有定制需要的场景下，去修改```nginx```源代码，再运行在商业场景下，这是合法的。

以上的优点是```nginx```最核心的特性。

## 4. 主要组成部分

首先是```nginx```的可执行文件，它是由```nginx```自身的框架、官方模块以及各种第三方模块共同构建的文件。他有完整的系统，所有的功能都由他提供。

第二个部分是```nginx.conf```配置文件，类似于骑车的驾驶员，虽然可执行文件已经提供了许多功能，但这些功能有没有开启，或者开启了以后定义了怎样的行为处理请求，都是由```nginx.conf```配置文件决定的。

```nginx```的第三个组成部分叫做```access.log```访问日志，```access.log```会记录下每一条```nginx```处理过的```http```请求信息与响应信息。

第四个组成部分是```error.log```错误日志，当出现了一些不可预期的问题时，可以通过```error.log```去把问题定位出来。

这四个部分是相辅相成的。

```nginx```的可执行文件和```nginx.conf```定义了处理请求的方式。如果想对web服务，做一些运营或者运维的分析，需要对```access.log```做进一步的分析。如果出现了任何未知的错误，或者与预期的行为不一致时，应该通过```error.log```去定位根本性的问题。

## 5. 版本规则

```nginx```每发布一个版本的时候会有三个特性，一个是```feature```，就是他新增了哪些功能，```bugfix```表示他修复了哪些```bug```，```change```表示做了哪些重构。

每一个版本都有```mainline```主干版本和```stable```稳定版本。

在```nginx```的官网点击右下角的```download```，就可以看到版本号列表，单数版本表示主干版本，会新增很多功能，但不一定稳定。双数版本是稳定版本。

```CHANGES```文件中可以看到每一个版本含有的新增功能，修复的```bug```，以及做了哪些小的重构。

大概在```2009```年以后```nginx```的```bugfix```数量已经大幅度减少，所以```nginx```相对已经很稳定了。

```nginx```的开发时间是在```2002```年，但是他在```2004```年```10```月```4```日推出了第一个版本，在```2005年```曾经做过一次大的重构。

因为```nginx```优秀的设计，使得他的生态圈极为丰富，模块的设计，架构的设计都没有再做过大的变动。

在```2009```年```nginx```开始支持```windows```操作系统，```2011```年```1.0```正式版本发布，同时```nginx```的商业公司```nginx Plus```也成立了，在```2015```年```nginx```发布了几个重要的功能。

其中提供```stream```，```四层反向代理```，他在功能上完全可以替代传统使用的```LVS```, 并且具有更丰富的功能。

## 6. 版本选择

免费开源: ```nginx.org```

商业版本: ```nginx.com```

开源免费的```nginx```在```2002```年开始开发，到```2004```年发布第一个版本，```2011```年开源版的```nginx```发布了```1.0```稳定版，同年```nginx```的作者成立了一家商业公司，开始推出```nginx Plus```商业版的```nginx```。

商业版的```nginx```在整合第三方模块上还有运营监控以及技术支持上有很多优点，但他有个最大的缺点就是不开源，所以通常在国内会使用```nginx.org```开源版的。

阿里巴巴也推出了```Tengine```版本，```Tengine```的优点就是在阿里巴巴生态下他经历了非常严苛的考验，```Tengine```之所以会存在也是因为他的很多特性领先于```nginx```的官方版本。

所以```Tengine```实际上是修改了```nginx```官网版本的主干代码，当然框架被修改以后```Tengine```就遇到了一个明显的问题，没有办法跟着```nginx```的官方版本同步的升级。```Tengine```也可以使用```nginx```的第三方模块。

```OpenResty```的作者章亦春在阿里巴巴的时候开发了```Lua```语言版本的```openResty```，因为```nginx```的第三方模块开发的难度相当大，章亦春把```nginx```非阻塞事件的一种框架以```Lua```语言的方式提供给了广大开发者。

```OenRestry```兼具了高性能，以及开发效率高的特点，```OpenResty```同样有开源版和商业版，目前多使用```openresty.org```站点下的开源版本。商业版```OpenRestry```的主要特点是技术支持相对比较好很多。

如果你没有太多的业务诉求，那么使用开源版的```nginx```就足够了，如果你需要开发```Api```服务器，或者需要开发```web```防火墙，```openrestry```是一个很好的选择。

## 7. 编译配置

安装```nginx```有两种方法，除了编译外，还可以直接用操作系统上自带的一些工具，比如说```yum```，```apt-get```，直接去安装```nginx```。

但是直接安装```nginx```有个问题，就是```nginx```的二进制文件不会把模块直接编译进来，毕竟```nginx```的官方模块，并不是每一个默认都会开启的。

如果想添加第三方的```nginx```模块，就必须通过编译```nginx```的方式。

编译```nginx```主要分为六个部分，首先需要