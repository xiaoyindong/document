## 1. 概述

当前案例中包含三个微应用，分别为```Marketing```、```Authentication```和```Dashboard```。

Marketing是营销微应用，包含首页组件和价格组件。```Authentication```是身份验证微应用，包含登录组件。```Dashboard```是仪表盘微应用，包含仪表盘组件。

容器应用、营销应用、身份验证应用使用```React```框架，仪表盘应用使用```Vue```框架。

## 2. Marketing应用

```json
{
  "name": "marketing",
  "version": "1.0.0",
  "scripts": {
    "start": "webpack serve"
  },
  "dependencies": {
    "@material-ui/core": "^4.11.0",
    "@material-ui/icons": "^4.9.1",
    "react": "^17.0.1",
    "react-dom": "^17.0.1",
    "react-router-dom": "^5.2.0"
  },
  "devDependencies": {
    "@babel/core": "^7.12.3",
    "@babel/plugin-transform-runtime": "^7.12.1",
    "@babel/preset-env": "^7.12.1",
    "@babel/preset-react": "^7.12.1",
    "babel-loader": "^8.1.0",
    "clean-webpack-plugin": "^3.0.0",
    "css-loader": "^5.0.0",
    "html-webpack-plugin": "^4.5.0",
    "style-loader": "^2.0.0",
    "webpack": "^5.4.0",
    "webpack-cli": "^4.1.0",
    "webpack-dev-server": "^3.11.0",
    "webpack-merge": "^5.2.0"
  }
}
```

### 1. 创建应用结构

```s
├── public
│   └── index.html
├── src
│   ├── bootstrap.js
│   └── index.js
├── package-lock.json
├── package.json
└── webpack.config.js
```

```html
<!-- index.html -->
<title>Marketing</title>
<div id="dev-marketing"></div>
```

```js
// index.js
import("./bootstrap")
```

```js
// bootstrap.js
console.log('Hello')
```

### 2. 配置 webpack。

```js
const HtmlWebpackPlugin = require("html-webpack-plugin")
module.exports = {
  mode: "development",
  devServer: {
		port: 8081,
		// 当使用 HTML5 History API 时, 所有的 404 请求都会响应 index.html 文件 
		historyApiFallback: true
	}, 
	module: {
		rules: [ 
			{
						test: /\.js$/,
						exclude: /node_modules/,
						use: {
							loader: "babel-loader",
							options: {
								presets: ["@babel/preset-react", "@babel/preset-env"], 
								// 1. 避免 babel 转义语法后 helper 函数重复
								// 2. 避免 babel polyfill 将 API 添加到全局
								plugins: ["@babel/plugin-transform-runtime"]
							} 
						}
			} 
		]
	}, 
	plugins: [
			new HtmlWebpackPlugin({
				template: "./public/index.html"
			}) 
	]
}
```

### 3. 添加启动命令。

```json
"scripts": {
  "start": "webpack serve"
}
```

### 4. 创建挂载方法

```js
// bootstrap.js
import React from "react"
import ReactDOM from "react-dom"

function mount(el) {
  ReactDOM.render(<div>Marketing works</div>, el)
}

if (process.env.NODE_ENV === "development") {
	const el = document.querySelector("#dev-marketing")
  if (el) {
		mount(el)
	}
}
```
 
### 5. 创建路由

在```src```文件夹中创建```components```文件夹用于放置页面组件，在```src```文件夹中创建```App```组件，用于编写路由。

```js
// App.js
import React from "react"
import { BrowserRouter, Route, Switch } from "react-router-dom"
import Landing from "./components/Landing"
import Pricing from "./components/Pricing"
export default function App() {
  return (
    <BrowserRouter>
      <Switch>
        <Route path="/pricing" component={Pricing} />
        <Route path="/" component={Landing} />
      </Switch>
    </BrowserRouter>
	) 
}
```

```js
// bootstrap.js
import App from "./App"
function mount(el) {
  ReactDOM.render(<App />, el)
}
```

## 3. Container应用

```json
{
  "name": "container",
  "version": "1.0.0",
  "scripts": {
    "start": "webpack serve"
  },
  "dependencies": {
    "@material-ui/core": "^4.11.0",
    "@material-ui/icons": "^4.9.1",
    "react": "^17.0.1",
    "react-dom": "^17.0.1",
    "react-router-dom": "^5.2.0"
  },
  "devDependencies": {
    "@babel/core": "^7.12.3",
    "@babel/plugin-transform-runtime": "^7.12.1",
    "@babel/preset-env": "^7.12.1",
    "@babel/preset-react": "^7.12.1",
    "babel-loader": "^8.1.0",
    "clean-webpack-plugin": "^3.0.0",
    "css-loader": "^5.0.0",
    "html-webpack-plugin": "^4.5.0",
    "style-loader": "^2.0.0",
    "webpack": "^5.4.0",
    "webpack-cli": "^4.1.0",
    "webpack-dev-server": "^3.11.0",
    "webpack-merge": "^5.2.0"
  }
}
```

### 1. 创建应用结构 (基于 Marketing 应用进行拷贝修改)。

```s
├── public
│   └── index.html
├── src
│   ├── bootstrap.js
│   └── index.js
├── package-lock.json
├── package.json
└── webpack.config.js
```

### 2. 修改 index.html

```html
<title>Container</title>
<div id="root"></div>
```

### 3. 修改 App.js

```js
import React from "react"
export default function App() {
  return <div>Container works</div>
}
```
   
### 4. 修改 bootstrap.js

```js
if (process.env.NODE_ENV === "development") {
  const el = document.querySelector("#root")
  if (el) mount(el)
}
```

### 5. 修改 webpack.config.js

```js
module.exports = {
  devServer: {
		port: 8080 
	}
}
```

### 6. Container 应用加载 Marketing

```Marketing```应用配置```ModuleFederation```。

```js
const ModuleFederationPlugin = require("webpack/lib/container/ModuleFederationPlugin")

new ModuleFederationPlugin({
  name: "marketing",
  filename: "remoteEntry.js",
  exposes: {
    "./MarketingApp": "./src/bootstrap"
  }
})
```

```Container```应用配置```ModuleFederation```。

```js
const ModuleFederationPlugin = require("webpack/lib/container/ModuleFederationPlugin")

new ModuleFederationPlugin({
  name: "container",
  remotes: {
    marketing: "marketing@http://localhost:8081/remoteEntry.js"
  }
})
```

在```Container```应用中新建```MarketingApp```组件，用于挂载```Marketing```应用。

```js
// Container/components/MarketingApp.js
import React, { useRef, useEffect } from "react"
import { mount } from "marketing/MarketingApp"
export default function MarketingApp() {
  const ref = useRef()
  useEffect(() => {
    mount(ref.current)
  }, [])
  return <div ref={ref}></div>
}
```

在```Container```应用中的```App```组件中渲染```Marketing```应用的。

```js
// Container/App.js
import React from "react"
import MarketingApp from "./components/MarketingApp"
export default function App() {
  return <MarketingApp />
}
```

## 4. 共享库设置

在```Container```应用和```Marketing```应用中都使用了大量的相同的代码库，如果不做共享处理，则应用中相
同的共享库会被加载两次。

```json
"dependencies": {
  "@material-ui/core": "^4.11.0",
  "@material-ui/icons": "^4.9.1",
  "react": "^17.0.1",
  "react-dom": "^17.0.1",
  "react-router-dom": "^5.2.0"
}
```

在```Container```应用和```Marketing```应用的```webpack```配置文件中加入以下代码。

```js
const packageJson = require("./package.json")

new ModuleFederationPlugin({
  shared: packageJson.dependencies
})
```

## 5. 路由配置

容器应用路由用于匹配微应用，微应用路由用于匹配组件。容器应用使用```BrowserHistory```路由，微应用使用```MemoryHistory```路由。

为防止容器应用和微应用同时操作```url```而产生冲突，在微前端架构中，只允许容器应用更新```url```， 微应用不允许更新```url```，```MemoryHistory```是基于内存的路由，不会改变浏览器地址栏中的```url```。如果不同的应用程序需要传达有关路由的相关信息，应该尽可能的使用通过的方式，```memoryHistory```在```React```和```Vue```中都有提供。

### 1. 更新现有路由配置

```Container```容器应用的路由配置。

```js
// Container/App.js
import { Router, Route, Switch } from "react-router-dom"
import { createBrowserHistory } from "history"
const history = createBrowserHistory()
export default function App() {
  return (
    <Router history={history}>
      <Switch>
        <Route path="/">
          <MarketingApp />
        </Route>
      </Switch>
		</Router>
	) 
}
```

```Marketing```应用的路由配置。

```js
// Marketing/bootstrap.js
import { createMemoryHistory } from "history"
function mount(el) {
  const history = createMemoryHistory()
  ReactDOM.render(<App history={history} />, el)
}
```

```js
// Marketing/app.js
import { Router, Route, Switch } from "react-router-dom"
export default function App({ history }) {
  return (
    <Router history={history}>
      <Switch>
        <Route path="/pricing" component={Pricing} />
        <Route path="/" component={Landing} />
      </Switch>
		</Router>
	) 
}
```
 
添加头部组件。

```js
import Header from "./components/Header"
export default function App() {
  return <Header />
}
```

### 2. 微应用和容器应用路由沟通

微应用路由变化时```url```地址没有被同步到浏览器的地址栏中，路由变化也没有被同步到浏览器的历史记录中。当微应用路由发生变化时通知容器应用更新路由信息 (容器应用向微应用传递方法)。

```js
// Container/components/MarketingApp.js
import { useHistory } from "react-router-dom"
const history = useHistory()
mount(ref.current, {
  onNavigate({ pathname: nextPathname }) {
    const { pathname } = history.location
    if (pathname !== nextPathname) {
      history.push(nextPathname)
    }
	} 
})
```

```js
// Marketing/bootstrap.js
function mount(el, { onNavigate }) {
  if (onNavigate) {
		history.listen(onNavigate)
	}
}
```

同样的，容器应用路由发生变化时只能匹配到微应用，微应用路由并不会响应容器应用路由的变化。 当容器应用路由发生变化时需要通知微应用路由进行响应 (微应用向容器应用传递方法)

```js
// Marketing/bootstrap.js
function mount(el, { onNavigate }) {
  return {
    onParentNavigate({ pathname: nextPathname }) {
      const { pathname } = history.location
      if (pathname !== nextPathname) {
        history.push(nextPathname)
      }
		}
	}
}
```

```js
// Container/components/MarketingApp.js
const { onParentNavigate } = mount()
if (onParentNavigate) {
  history.listen(onParentNavigate)
}
```

### 5. Marketing 应用本地路由设置

目前```Marketing```应用本地开发环境是报错的，原因是本地开发环境在调用```mount```方法时没有传递第二个参数，默认值就是```undefined```,```mount```方法内部试图从```undefined```中解构```onNavigate```所以就报错了。解决办法是在本地开发环境调用```mount```方法时传递一个空对象。

```js
if (process.env.NODE_ENV === "development") {
  if (el) mount(el, {})
}
```

如果当前为本地开发环境，路由依然使用```BrowserHistory```，所以在调用```mount```方法时传递```defaultHistory```做区分。

```js
// Marketing/bootstrap.js
if (process.env.NODE_ENV === "development") {
  if (el) mount(el, { defaultHistory: createBrowserHistory() })
}
```

在```mount```方法内部判断```defaultHistory```是否存在，如果存在就用```defaultHistory```，否则就用```MemoryHistory```。

```js
// Marketing/bootstrap.js
function mount(el, { onNavigate, defaultHistory }) {
  const history = defaultHistory || createMemoryHistory()
}
```

## 6. Authentication 应用

```json
{
  "name": "auth",
  "version": "1.0.0",
  "scripts": {
    "start": "webpack serve"
  },
  "dependencies": {
    "@material-ui/core": "^4.11.0",
    "@material-ui/icons": "^4.9.1",
    "react": "^17.0.1",
    "react-dom": "^17.0.1",
    "react-router-dom": "^5.2.0"
  },
  "devDependencies": {
    "@babel/core": "^7.12