## 1. 概述

```web```性能说简单点就是网站打开速度快不快，页面中的动画够不够流畅，表单提交的速度是否够快，列表滚动页面切换是否卡顿。性能优化就是让网站变得快。

在```MDN```上对```web```性能的定义是网站或应用程序的客观度量和可感知的用户体验。比如减少页面加载事件(减少文件体积，减少```HTTP```请求，使用预加载)，让网站尽快可用(懒加载或者分片加载)，平滑的交互性(使用```CSS```替代```JS```动画，减少```UI```重绘)，感知表现(加载动画，```loading```等给用户感觉快)，性能测定(性能指标，性能测试，性能监控以便持续优化，毕竟性能优化是个持续的过程)。

页面性能关乎到用户的留存，网站的转换率，用户体验和网站的传播，甚至影响搜索排名遭到用户投诉，当然也会影响开发的效率。

## 2. 性能指标

进行性能优化之前首先要知道要在哪些方面做性能优化。

首先需要了解性能指标，多快的速度才算快呢？可以使用专业的工具可量化的评估出网站或应用的性能表现。

立足于网站页面响应的生命周期，分析出造成较差性能表现的原因，最后进行技术改造，可行性分析等具体的优化措施，持续迭代优化就可以了。

事实上性能是相对的，他并不是绝对的概念。对于一个用户而言在不同的网络环境下访问页面的速度可能是不同的。即使相同的网站在懒加载的情况下也会显得快。

在讨论性能的时候精确地，可量化的指标是很重要的。但是仅仅因为一个度量标准是基于客观准备并且可以定量的度量的，并不一定意味这些度量是有用的。对于```Web```开发人员来说，如何恒量一个```Web```页面的性能一直都是一个难题。

最初，开发人员使用```Time to To Byte```。```DomContentLoaded```和```Load```这些恒量文档加载进度的指标，但他们不能直接反应用户视觉体验。

为了恒量用户视觉体验，Web标准中定义了一些性能指标。这些性能指标被各大浏览器标准化实现，例如```First Paint```和```First Contentful Paint```。

还有一些由Web孵化器社区组提出的性能指标，如```Largest COntentful Paint```, ```Time to Interactive```, ```First Input Delay```, ```First CPU Idle```。

另外还有```Google```提出的```First Meaningful Paint```, ```Speed Index```。

百度提出的```First Screen Paint```。

这些指标之间并不是毫无关联，而是在以用户为中心的目标中不断演进出来的，有的已经不再建议使用，有的被各种测试工具实现，有的则可以作为通用标准可用于生产环境测量的API。

## 3. RAIL性能模型

```RAIL```是```Response```，```Animation```，```Idle```和```Load```的首字母缩写，是一种由```Google Chrome```团队于```2015年```提出的性能模型，用于提升浏览器的用户体验和性能。

```RAIL```模型的理念是以用户为中心，最终目标并不是让你的网站在任何特定设备上都能运行很快，而是使用户满意。

```Response```: 应该尽可能快速的响应用户的操作，应在在```100ms```以内响应用户输入。

```Animation```: 在展示动画的时候，每一帧应该以```16ms```进行渲染，这样可以保持动画效果的一致性，并且避免卡顿。

```Idle```: 当使用```js```主线程的时候，应该把任务划分到执行时间小于```50ms```的片段中去，这样可以释放线程以进行用户交互。```50ms```为单位是为了保证用户在发生操作的```100ms```内做出响应。

要使网站响应迅速，动画流畅，通常都需要较长的处理时间，但以用户为中心来看待性能问题，就会发现并非所有工作都需要在响应和加载阶段完成，完全可以利用浏览器的空闲时间处理可延迟的任务，只要让用户感受不到延迟即可。利用空闲时间处理延迟可减少预加载的数据大小，以保证网站或应用快速完成加载。

```Load```: 应该在小于```1s```的时间内加载完成你的网站，并可以进行用户交互。根据网络条件和硬件的不同，用户对性能延迟的理解也有所不同，在```3G```网络需要花费更多的时间，```5s```是一个更现实的目标。

基于用户体验的性能指标其中包括一下几个比较重要的性能指标。

### 1. FCP (First Contentful Paint)

首次内容绘制，浏览器首次绘制来自```DOM```的内容的时间，内容必须包括文本，图片，非白色的```canvas```或```svg```，也包括带有正在加载中的```web```字体文本。这是用户第一次看到的内容。

| FCP时间(秒) | 颜色编码 | FPC分数 |
| -- | -- | -- |
| 0 - 2 | 绿色(快) | 75 - 100 |
| 2 - 4 | 橙色(中等) | 50 - 74 |
| 超过4 | 红色(慢) | 0 - 49 |

### 2. LCP (Largest Contentful Paint)

最大内容绘制，可视区域中最大的内容元素呈现到屏幕上的时间，用以估算页面的主要内容对用户的可见时间。```img```图片，```video```元素的封面，通过```url```加载到的北京，文本节点等，为了提供更好的用户体验，网站应该在```2.5s```以内或者更短的时间最大内容绘制。

| LCP时间(秒) | 颜色编码 |
| -- | -- |
| 0 - 2.5 | 绿色(快) |
| 2.5 - 4 | 橙色(中等) |
| 超过4 | 红色(慢) |

### 3. FID (First Input Delay)

首次输入延迟，从用户第一次与页面进行交互到浏览器实际能够响应该交互的时间，输入延迟是因为浏览器的主线程正忙于做其他事情，所以不能响应用户，发生这种情况的一个常见原因是浏览器正忙于解析和执行应用程序加载的大量计算的```JavaScript```。

| FID时间(毫秒) | 颜色编码 |
| -- | -- |
| 0 - 100 | 绿色(快) |
| 100 - 300 | 橙色(中等) |
| 超过300 | 红色(慢) |

### 4. TTI (Time to Interactive)

网页第一次完全达到可交互状态的时间点，浏览器已经可以持续的响应用户的输入，完全达到可交互的状态的时间是在最后一个长任务完成的时间，并且在随后的```5s```内网络和主线程是空闲的。从定义上来看，中文名称叫持续可交互时间或可流畅交互时间更合适。

| TTI时间(秒) | 颜色编码 |
| -- | -- |
| 0 - 3.8 | 绿色(快) |
| 3.9 - 7.3 | 橙色(中等) |
| 超过7.3 | 红色(慢) |

### 5. TBT (Total Block Time)

总阻塞时间，度量了```FCP```和```TTI```之间的总时间，在该时间范围内，主线程被阻塞足够长的时间以防止输入响应。只要存在长任务，该主线程就会被视为阻塞，该任务在主线程上运行超过```50```毫秒。

线程阻塞是因为浏览器无法中断正在进行的任务，因此如果用户确实在较